{% extends 'socialapp/base.html' %}
{% load static %}
{% block content %}

<h2>{{ profile_user.username }}'s Profile</h2>

{% if request.user != profile_user %}
    {% if request.user in profile.followers.all %}
        <form action="{% url 'unfollow_user' profile_user.username %}" method="post">
            {% csrf_token %}
            <button type="submit">Unfollow</button>
        </form>
    {% else %}
        <form action="{% url 'follow_user' profile_user.username %}" method="post">
            {% csrf_token %}
            <button type="submit">Follow</button>
        </form>
    {% endif %}
{% endif %}

<p><strong>Followers:</strong> {{ profile.followers.count }}</p>

{% if request.user == profile_user %}
    <a href="{% url 'edit_profile' profile_user.username %}">Edit Profile</a>
{% endif %}

{% if profile.profile_pic %}
    <img src="{{ profile.profile_pic.url }}" width="150" height="150" style="border-radius: 50%;">
{% else %}
    <img src="{% static 'default.png' %}" width="150" height="150" style="border-radius: 50%;">
{% endif %}

<p><strong>Bio:</strong> {{ profile.bio|linebreaks }}</p>

<h3>Posts by {{ profile_user.username }}</h3>
{% for post in posts %}
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
        {% if post.image %}
            <img src="{{ post.image.url }}" width="300"><br>
        {% endif %}

        <p><strong>Caption:</strong> {{ post.caption }}</p>
        <small>Posted on {{ post.created_at }}</small>

        <!-- üëç Like count and like/unlike form -->
        <p>
            <strong>Likes:</strong> {{ post.like_set.count }}
        </p>

        {% if user.is_authenticated %}
            <form method="post" action="{% url 'toggle_like' post.id %}">
                {% csrf_token %}
                {% if post.id in user_liked_posts %}
                     <button type="submit">üíî Unlike</button>
                {% else %}
                     <button type="submit">‚ù§Ô∏è Like</button>
                {% endif %}
            </form>
        {% endif %}

        <!-- üí¨ Comment Section -->
        <div style="margin-top: 10px;">
            <h4>Comments:</h4>
            {% for comment in post.comment_set.all %}
                <p><strong>{{ comment.user.username }}:</strong> {{ comment.content }}</p>
            {% empty %}
                <p>No comments yet.</p>
            {% endfor %}

            {% if user.is_authenticated %}
                <form method="post" action="{% url 'add_comment' post.id %}">
                    {% csrf_token %}
                    <input type="text" name="content" placeholder="Add a comment..." required style="width: 80%;">
                    <button type="submit">Post</button>
                </form>
            {% endif %}
        </div>
    </div>
{% empty %}
    <p>No posts yet.</p>
{% endfor %}

{% endblock %}
